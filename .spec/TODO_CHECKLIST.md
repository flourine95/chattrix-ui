# TODO Checklist - Rich Media Chat Features

## ‚úÖ ƒê√£ Ho√†n Th√†nh

- [x] M·ªü r·ªông Message model v·ªõi c√°c tr∆∞·ªùng m·ªõi
- [x] T·∫°o CloudinaryService ƒë·ªÉ upload media
- [x] T·∫°o MediaPickerService ƒë·ªÉ ch·ªçn media t·ª´ thi·∫øt b·ªã
- [x] T·∫°o AttachmentPickerBottomSheet UI
- [x] T·∫°o c√°c MessageBubble widgets cho t·ª´ng lo·∫°i tin nh·∫Øn
- [x] C·∫≠p nh·∫≠t API layer ƒë·ªÉ h·ªó tr·ª£ rich media
- [x] T√≠ch h·ª£p attachment picker v√†o chat view
- [x] S·ª≠a l·ªói CloudinaryResponse API
- [x] D·ªçn d·∫πp warnings v√† unused code
- [x] Build runner th√†nh c√¥ng
- [x] Flutter analyze pass (ch·ªâ 1 info v·ªÅ deprecated API)

## üîß C·∫ßn L√†m Ngay (B·∫Øt Bu·ªôc)

### 1. C·∫•u H√¨nh Cloudinary ‚ö†Ô∏è QUAN TR·ªåNG

**File:** `lib/core/services/cloudinary_service.dart`

```dart
// D√≤ng 11-12, thay th·∫ø:
static const String _cloudName = 'dk3gud5kq';  // ‚Üê Thay b·∫±ng cloud name c·ªßa b·∫°n
static const String _uploadPreset = 'chattrix_media';  // ‚Üê Thay b·∫±ng preset c·ªßa b·∫°n
```

**C√°c b∆∞·ªõc:**
1. ƒêƒÉng k√Ω t√†i kho·∫£n t·∫°i https://cloudinary.com
2. T·∫°o upload preset (unsigned) t√™n `chattrix_media`
3. Copy cloud name t·ª´ dashboard
4. C·∫≠p nh·∫≠t 2 d√≤ng tr√™n

**Xem chi ti·∫øt:** `CLOUDINARY_SETUP.md`

### 2. C·∫≠p Nh·∫≠t Backend Database ‚ö†Ô∏è QUAN TR·ªåNG

**Ch·∫°y SQL migration:**
```sql
ALTER TABLE messages 
ADD COLUMN type VARCHAR(20) DEFAULT 'TEXT',
ADD COLUMN media_url TEXT,
ADD COLUMN thumbnail_url TEXT,
ADD COLUMN file_name VARCHAR(255),
ADD COLUMN file_size BIGINT,
ADD COLUMN duration INTEGER,
ADD COLUMN latitude DOUBLE PRECISION,
ADD COLUMN longitude DOUBLE PRECISION,
ADD COLUMN location_name VARCHAR(255),
ADD COLUMN reply_to_message_id INTEGER,
ADD COLUMN reactions JSONB,
ADD COLUMN mentions JSONB;

CREATE INDEX idx_messages_type ON messages(type);
CREATE INDEX idx_messages_reply_to ON messages(reply_to_message_id);
```

### 3. C·∫≠p Nh·∫≠t Backend API ‚ö†Ô∏è QUAN TR·ªåNG

**Endpoint:** `POST /v1/conversations/{id}/messages`

**Request body c·∫ßn nh·∫≠n th√™m c√°c tr∆∞·ªùng:**
- `type` (string, optional)
- `mediaUrl` (string, optional)
- `thumbnailUrl` (string, optional)
- `fileName` (string, optional)
- `fileSize` (integer, optional)
- `duration` (integer, optional)
- `latitude` (double, optional)
- `longitude` (double, optional)
- `locationName` (string, optional)
- `replyToMessageId` (integer, optional)
- `mentions` (string, optional)
- `reactions` (string, optional)

**Response c·∫ßn tr·∫£ v·ªÅ t·∫•t c·∫£ c√°c tr∆∞·ªùng tr√™n (c√≥ th·ªÉ null)**

**Xem chi ti·∫øt:** `API_REQUIREMENTS.md`

### 4. Test C∆° B·∫£n

```bash
# 1. Ch·∫°y app
flutter run

# 2. Test c√°c ch·ª©c nƒÉng:
- [ ] G·ª≠i tin nh·∫Øn text (ph·∫£i ho·∫°t ƒë·ªông nh∆∞ c≈©)
- [ ] Nh·∫•n n√∫t attachment (üìé)
- [ ] Ch·ªçn Gallery
- [ ] Ch·ªçn 1 ·∫£nh
- [ ] Xem ·∫£nh upload v√† hi·ªÉn th·ªã trong chat
```

## üìã C·∫ßn L√†m Sau (T√πy Ch·ªçn)

### 1. Implement Reply Feature

**UI c·∫ßn t·∫°o:**
- [ ] N√∫t reply tr√™n m·ªói tin nh·∫Øn
- [ ] Hi·ªÉn th·ªã quoted message khi reply
- [ ] Cancel reply button
- [ ] Scroll to original message khi tap v√†o quoted message

**Backend:**
- [ ] API ƒë√£ h·ªó tr·ª£ `replyToMessageId` field
- [ ] WebSocket broadcast reply messages

### 2. Implement Reactions Feature

**UI c·∫ßn t·∫°o:**
- [ ] Emoji picker bottom sheet
- [ ] Hi·ªÉn th·ªã reactions d∆∞·ªõi tin nh·∫Øn
- [ ] Tap ƒë·ªÉ add/remove reaction
- [ ] Hi·ªÉn th·ªã danh s√°ch users ƒë√£ react

**Backend c·∫ßn th√™m:**
- [ ] `POST /v1/messages/{id}/reactions` - Add reaction
- [ ] `DELETE /v1/messages/{id}/reactions/{emoji}` - Remove reaction
- [ ] WebSocket broadcast reaction updates

**Data structure:**
```json
{
  "reactions": "{\"üëç\": [1, 2, 3], \"‚ù§Ô∏è\": [4, 5]}"
}
```

### 3. Implement Mentions Feature

**UI c·∫ßn t·∫°o:**
- [ ] Autocomplete khi g√µ @ trong input
- [ ] Hi·ªÉn th·ªã danh s√°ch users ƒë·ªÉ mention
- [ ] Highlight mentions trong tin nh·∫Øn
- [ ] Tap v√†o mention ƒë·ªÉ xem profile

**Backend:**
- [ ] API parse mentions t·ª´ content
- [ ] G·ª≠i notification cho users ƒë∆∞·ª£c mention
- [ ] WebSocket broadcast mentions

**Data structure:**
```json
{
  "content": "@john @jane Check this out!",
  "mentions": "[123, 456]"
}
```

### 4. Voice Recording

**Packages c·∫ßn th√™m:**
```yaml
dependencies:
  record: ^5.0.0  # Ho·∫∑c flutter_sound
  path_provider: ^2.1.0
```

**Ch·ª©c nƒÉng:**
- [ ] N√∫t record trong input bar
- [ ] Recording UI v·ªõi waveform
- [ ] Pause/Resume recording
- [ ] Cancel/Send recording
- [ ] Upload audio file l√™n Cloudinary

### 5. Video Recording

**Packages c·∫ßn th√™m:**
```yaml
dependencies:
  camera: ^0.10.0
```

**Ch·ª©c nƒÉng:**
- [ ] M·ªü camera ƒë·ªÉ quay video
- [ ] Preview video tr∆∞·ªõc khi g·ª≠i
- [ ] Trim video (optional)
- [ ] Upload video l√™n Cloudinary

### 6. Media Preview Before Sending

**Ch·ª©c nƒÉng:**
- [ ] Preview ·∫£nh/video tr∆∞·ªõc khi g·ª≠i
- [ ] Th√™m caption
- [ ] Crop/rotate ·∫£nh (optional)
- [ ] Compress media
- [ ] Cancel/Send

### 7. Image Compression

**Package:**
```yaml
dependencies:
  flutter_image_compress: ^2.0.0
```

**Ch·ª©c nƒÉng:**
- [ ] T·ª± ƒë·ªông compress ·∫£nh tr∆∞·ªõc khi upload
- [ ] Gi·∫£m k√≠ch th∆∞·ªõc file
- [ ] Gi·ªØ ch·∫•t l∆∞·ª£ng h·ª£p l√Ω
- [ ] Ti·∫øt ki·ªám bandwidth v√† storage

### 8. Upload Progress Indicator

**Ch·ª©c nƒÉng:**
- [ ] Hi·ªÉn th·ªã progress bar khi upload
- [ ] Cho ph√©p cancel upload
- [ ] Retry n·∫øu upload fail
- [ ] Queue multiple uploads

### 9. Media Gallery View

**Ch·ª©c nƒÉng:**
- [ ] Tap v√†o ·∫£nh/video ƒë·ªÉ xem fullscreen
- [ ] Swipe ƒë·ªÉ xem ·∫£nh/video kh√°c
- [ ] Zoom in/out
- [ ] Share/Download media
- [ ] View all media trong conversation

### 10. Backend File Deletion

**Backend API:**
```javascript
// Node.js example
app.delete('/api/media/:publicId', async (req, res) => {
  const cloudinary = require('cloudinary').v2;
  await cloudinary.uploader.destroy(req.params.publicId);
  res.json({ success: true });
});
```

**Flutter:**
```dart
// Update CloudinaryService.deleteFile() to call backend API
Future<void> deleteFile(String publicId) async {
  await http.delete(Uri.parse('$baseUrl/api/media/$publicId'));
}
```

## üêõ Known Issues

### 1. Deprecated Geolocator API

**Warning:**
```
'desiredAccuracy' is deprecated and shouldn't be used.
```

**Fix (optional):**
```dart
// File: lib/core/services/media_picker_service.dart
// Line 185, thay th·∫ø:
final position = await Geolocator.getCurrentPosition(
  desiredAccuracy: LocationAccuracy.high,
);

// B·∫±ng:
final position = await Geolocator.getCurrentPosition(
  locationSettings: const LocationSettings(
    accuracy: LocationAccuracy.high,
  ),
);
```

### 2. WebSocket Send Message

**Issue:** WebSocket hi·ªán t·∫°i ch·ªâ g·ª≠i text content

**Fix needed:**
```dart
// File: lib/core/services/chat_websocket_service.dart
// Update sendMessage() method ƒë·ªÉ g·ª≠i th√™m:
// - type
// - mediaUrl
// - thumbnailUrl
// - fileName
// - fileSize
// - duration
// - latitude
// - longitude
// - locationName
```

## üìä Testing Checklist

### Manual Testing

- [ ] **Text messages** - G·ª≠i v√† nh·∫≠n text b√¨nh th∆∞·ªùng
- [ ] **Image from gallery** - Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán
- [ ] **Take photo** - Ch·ª•p ·∫£nh b·∫±ng camera
- [ ] **Video from gallery** - Ch·ªçn video t·ª´ th∆∞ vi·ªán
- [ ] **Audio file** - Ch·ªçn file audio
- [ ] **Document file** - Ch·ªçn PDF/DOCX
- [ ] **Location sharing** - Chia s·∫ª v·ªã tr√≠ GPS
- [ ] **Image display** - ·∫¢nh hi·ªÉn th·ªã ƒë√∫ng trong chat
- [ ] **Video display** - Video c√≥ thumbnail v√† play button
- [ ] **Audio display** - Audio c√≥ play button v√† duration
- [ ] **Document display** - Document c√≥ icon v√† file name
- [ ] **Location display** - Location c√≥ map preview
- [ ] **WebSocket receive** - Nh·∫≠n tin nh·∫Øn real-time
- [ ] **Scroll performance** - Scroll m∆∞·ª£t v·ªõi nhi·ªÅu media
- [ ] **Memory usage** - Kh√¥ng b·ªã memory leak

### Error Handling

- [ ] **No internet** - Hi·ªÉn th·ªã error khi kh√¥ng c√≥ m·∫°ng
- [ ] **Upload failed** - Hi·ªÉn th·ªã error v√† cho ph√©p retry
- [ ] **Permission denied** - Hi·ªÉn th·ªã message khi kh√¥ng c√≥ permission
- [ ] **File too large** - Hi·ªÉn th·ªã error khi file qu√° l·ªõn
- [ ] **Invalid file type** - Hi·ªÉn th·ªã error khi file type kh√¥ng h·ª£p l·ªá
- [ ] **Backend error** - Hi·ªÉn th·ªã error khi API fail

### Performance Testing

- [ ] **Large images** - Test v·ªõi ·∫£nh > 5MB
- [ ] **Long videos** - Test v·ªõi video > 1 ph√∫t
- [ ] **Many messages** - Test v·ªõi > 100 tin nh·∫Øn
- [ ] **Slow network** - Test v·ªõi 3G/2G
- [ ] **Low memory device** - Test tr√™n thi·∫øt b·ªã c≈©

## üìö Documentation Files

- `README.md` - T·ªïng quan project (n·∫øu c√≥)
- `API_REQUIREMENTS.md` - Chi ti·∫øt backend API requirements
- `CLOUDINARY_SETUP.md` - H∆∞·ªõng d·∫´n c·∫•u h√¨nh Cloudinary
- `IMPLEMENTATION_SUMMARY_VI.md` - T√≥m t·∫Øt implementation (ti·∫øng Vi·ªát)
- `QUICK_START.md` - H∆∞·ªõng d·∫´n b·∫Øt ƒë·∫ßu nhanh
- `BUGFIX_CLOUDINARY.md` - Chi ti·∫øt bug fix CloudinaryResponse
- `TODO_CHECKLIST.md` - File n√†y

## üéØ Priority Order

### Must Do (B·∫Øt bu·ªôc):
1. ‚ö†Ô∏è C·∫•u h√¨nh Cloudinary
2. ‚ö†Ô∏è C·∫≠p nh·∫≠t backend database
3. ‚ö†Ô∏è C·∫≠p nh·∫≠t backend API
4. ‚ö†Ô∏è Test basic functionality

### Should Do (N√™n l√†m):
5. Implement reply feature
6. Implement reactions
7. Implement mentions
8. Add upload progress indicator
9. Add image compression

### Nice to Have (T√πy ch·ªçn):
10. Voice recording
11. Video recording
12. Media preview before sending
13. Media gallery view
14. Backend file deletion

## üí° Tips

1. **Test t·ª´ng feature m·ªôt** - ƒê·ª´ng implement t·∫•t c·∫£ c√πng l√∫c
2. **B·∫Øt ƒë·∫ßu v·ªõi basic** - Text, image, video tr∆∞·ªõc
3. **Test tr√™n real device** - Kh√¥ng ch·ªâ emulator
4. **Monitor Cloudinary usage** - Free tier c√≥ gi·ªõi h·∫°n
5. **Optimize images** - Compress tr∆∞·ªõc khi upload
6. **Handle errors gracefully** - Lu√¥n c√≥ fallback UI
7. **Log everything** - Debug logs gi√∫p fix bug nhanh h∆°n

## üöÄ Ready to Start?

1. ‚úÖ Code ƒë√£ s·∫µn s√†ng
2. ‚è≥ C·∫ßn c·∫•u h√¨nh Cloudinary
3. ‚è≥ C·∫ßn c·∫≠p nh·∫≠t backend
4. ‚è≥ S·∫µn s√†ng test

**Next step:** ƒê·ªçc `QUICK_START.md` ƒë·ªÉ b·∫Øt ƒë·∫ßu! üéâ

