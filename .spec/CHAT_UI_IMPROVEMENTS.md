# üí¨ Chat UI Improvements - Conversation Display & Scroll Behavior

## üìã T·ªïng quan

ƒê√£ c·∫≠p nh·∫≠t m√†n h√¨nh chat v√† danh s√°ch h·ªôi tho·∫°i v·ªõi c√°c t√≠nh nƒÉng m·ªõi:
- Hi·ªÉn th·ªã t√™n ƒëo·∫°n chat theo quy t·∫Øc (GROUP vs DIRECT v·ªõi nickname fallback)
- Hi·ªÉn th·ªã tin nh·∫Øn cu·ªëi c√πng v·ªõi format ƒë·∫∑c bi·ªát
- Hi·ªÉn th·ªã tr·∫°ng th√°i online/offline v√† last seen
- C·∫£i thi·ªán scroll behavior trong chat view

## ‚ú® T√≠nh nƒÉng ƒë√£ th√™m

### 1. **Conversation Title Display Rules**

#### **GROUP Conversations**:
- **∆Øu ti√™n 1**: Hi·ªÉn th·ªã `conversation.name` n·∫øu c√≥
- **Fallback**: G·ªôp t√™n th√†nh vi√™n (t·ªëi ƒëa 3 ng∆∞·ªùi, c√°ch nhau b·∫±ng d·∫•u ph·∫©y)

#### **DIRECT Conversations**:
- **∆Øu ti√™n 1**: `contact.nickname` (n·∫øu c√≥)
- **∆Øu ti√™n 2**: `contactUser.fullName` (n·∫øu kh√¥ng c√≥ nickname)
- **∆Øu ti√™n 3**: `contactUser.username` (n·∫øu kh√¥ng c√≥ fullName)

### 2. **Last Message Display**

#### **Format Rules**:
- N·∫øu tin nh·∫Øn t·ª´ ch√≠nh user ‚Üí th√™m ti·ªÅn t·ªë **"B·∫°n:"**
- N·∫øu tin nh·∫Øn l√† ·∫£nh ‚Üí hi·ªÉn th·ªã **"üì∑ ·∫¢nh"**
- N·∫øu tin nh·∫Øn l√† file ‚Üí hi·ªÉn th·ªã **"üìé T·ªáp"**
- Ng∆∞·ª£c l·∫°i ‚Üí hi·ªÉn th·ªã n·ªôi dung tin nh·∫Øn

#### **Display Logic**:
- **DIRECT**: Hi·ªÉn th·ªã last message ho·∫∑c last seen status (n·∫øu kh√¥ng c√≥ message)
- **GROUP**: Hi·ªÉn th·ªã last message

### 3. **User Status Display**

#### **Online Indicator**:
- Ch·∫•m xanh nh·ªè b√™n c·∫°nh avatar (ch·ªâ cho DIRECT conversations)
- Hi·ªÉn th·ªã khi `contactUser.isOnline = true`

#### **Last Seen**:
- N·∫øu online: **"ƒêang ho·∫°t ƒë·ªông"**
- N·∫øu offline: **"Ho·∫°t ƒë·ªông X ph√∫t/gi·ªù/ng√†y tr∆∞·ªõc"**
- T√≠nh d·ª±a tr√™n `lastSeen` timestamp

### 4. **Chat View Scroll Improvements**

#### **No Auto-Scroll on Open**:
- Kh√¥ng t·ª± ƒë·ªông scroll xu·ªëng khi m·ªü chat
- User c√≥ th·ªÉ xem tin nh·∫Øn c≈© ngay l·∫≠p t·ª©c

#### **Scroll on New Message**:
- Ch·ªâ scroll xu·ªëng khi c√≥ tin m·ªõi **V√Ä** user ƒëang ·ªü g·∫ßn cu·ªëi (trong v√≤ng 200px)
- Kh√¥ng scroll n·∫øu user ƒëang xem tin c≈©

#### **Floating Scroll Button**:
- Hi·ªÉn th·ªã n√∫t "cu·ªôn xu·ªëng" khi user scroll l√™n > 100px
- Click ƒë·ªÉ scroll xu·ªëng cu·ªëi v·ªõi animation m∆∞·ª£t

## üèóÔ∏è Implementation Details

### **1. Updated Entities**

#### **Conversation Entity**:
```dart
@freezed
abstract class Conversation with _$Conversation {
  const factory Conversation({
    required int id,
    String? name,
    required String type,
    required DateTime createdAt,
    required DateTime updatedAt,
    required List<Participant> participants,
    Message? lastMessage,  // ‚Üê NEW
  }) = _Conversation;
}
```

#### **Participant Entity**:
```dart
@freezed
abstract class Participant with _$Participant {
  const factory Participant({
    required int userId,
    required String username,
    required String fullName,
    required String role,
    String? email,        // ‚Üê NEW
    String? nickname,     // ‚Üê NEW
    bool? isOnline,       // ‚Üê NEW
    DateTime? lastSeen,   // ‚Üê NEW
  }) = _Participant;
}
```

### **2. Utility Functions**

Created `lib/features/chat/presentation/utils/conversation_utils.dart`:

#### **getConversationTitle()**:
```dart
static String getConversationTitle(Conversation conversation, User? currentUser) {
  if (conversation.type.toUpperCase() == 'GROUP') {
    // Use conversation.name or combine participant names
    if (conversation.name != null && conversation.name!.isNotEmpty) {
      return conversation.name!;
    }
    
    final otherParticipants = conversation.participants
        .where((p) => p.userId != currentUser?.id)
        .take(3)
        .toList();
    
    return otherParticipants
        .map((p) => p.fullName.isNotEmpty ? p.fullName : p.username)
        .join(', ');
  } else {
    // DIRECT: nickname ‚Üí fullName ‚Üí username
    final otherParticipant = conversation.participants.firstWhere(
      (p) => p.userId != currentUser?.id,
      orElse: () => conversation.participants.first,
    );
    
    if (otherParticipant.nickname != null && otherParticipant.nickname!.isNotEmpty) {
      return otherParticipant.nickname!;
    }
    
    if (otherParticipant.fullName.isNotEmpty) {
      return otherParticipant.fullName;
    }
    
    return otherParticipant.username;
  }
}
```

#### **formatLastMessage()**:
```dart
static String formatLastMessage(Message? lastMessage, User? currentUser) {
  if (lastMessage == null) {
    return 'No messages yet';
  }
  
  String content;
  
  // Check message type
  if (lastMessage.type.toUpperCase() == 'IMAGE') {
    content = 'üì∑ ·∫¢nh';
  } else if (lastMessage.type.toUpperCase() == 'FILE') {
    content = 'üìé T·ªáp';
  } else {
    content = lastMessage.content;
  }
  
  // Add "B·∫°n: " prefix if message is from current user
  if (currentUser != null && lastMessage.sender.id == currentUser.id) {
    return 'B·∫°n: $content';
  }
  
  return content;
}
```

#### **formatTimeAgo()**:
```dart
static String formatTimeAgo(DateTime dateTime) {
  final now = DateTime.now();
  final difference = now.difference(dateTime);
  
  if (difference.inSeconds < 60) {
    return 'V·ª´a xong';
  } else if (difference.inMinutes < 60) {
    return '${difference.inMinutes} ph√∫t tr∆∞·ªõc';
  } else if (difference.inHours < 24) {
    return '${difference.inHours} gi·ªù tr∆∞·ªõc';
  } else if (difference.inDays < 7) {
    return '${difference.inDays} ng√†y tr∆∞·ªõc';
  } else if (difference.inDays < 30) {
    final weeks = (difference.inDays / 7).floor();
    return '$weeks tu·∫ßn tr∆∞·ªõc';
  } else if (difference.inDays < 365) {
    final months = (difference.inDays / 30).floor();
    return '$months th√°ng tr∆∞·ªõc';
  } else {
    final years = (difference.inDays / 365).floor();
    return '$years nƒÉm tr∆∞·ªõc';
  }
}
```

#### **formatLastSeen()**:
```dart
static String formatLastSeen(bool isOnline, DateTime? lastSeen) {
  if (isOnline) {
    return 'ƒêang ho·∫°t ƒë·ªông';
  }
  
  if (lastSeen == null) {
    return 'Offline';
  }
  
  return 'Ho·∫°t ƒë·ªông ${formatTimeAgo(lastSeen)}';
}
```

### **3. Updated Chat List Page**

File: `lib/features/chat/presentation/pages/chat_list_page.dart`

#### **Key Changes**:

1. **Use ConversationUtils for title**:
```dart
final title = ConversationUtils.getConversationTitle(c, me);
```

2. **Format last message**:
```dart
final lastMessageText = ConversationUtils.formatLastMessage(c.lastMessage, me);
```

3. **Check online status**:
```dart
final isOnline = ConversationUtils.isUserOnline(c, me);
final lastSeen = ConversationUtils.getLastSeen(c, me);
```

4. **Display subtitle based on type**:
```dart
String subtitle;
if (c.type.toUpperCase() == 'DIRECT') {
  if (c.lastMessage != null) {
    subtitle = lastMessageText;
  } else {
    subtitle = ConversationUtils.formatLastSeen(isOnline, lastSeen);
  }
} else {
  subtitle = lastMessageText;
}
```

5. **Online indicator**:
```dart
leading: Stack(
  children: [
    CircleAvatar(...),
    // Online indicator for DIRECT conversations
    if (c.type.toUpperCase() == 'DIRECT' && isOnline)
      Positioned(
        right: 0,
        bottom: 0,
        child: Container(
          width: 14,
          height: 14,
          decoration: BoxDecoration(
            color: Colors.green,
            shape: BoxShape.circle,
            border: Border.all(
              color: Theme.of(context).scaffoldBackgroundColor,
              width: 2,
            ),
          ),
        ),
      ),
  ],
),
```

6. **Time ago in trailing**:
```dart
trailing: c.lastMessage != null
    ? Text(
        ConversationUtils.formatTimeAgo(c.lastMessage!.createdAt),
        style: textTheme.bodySmall?.copyWith(
          color: Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6),
        ),
      )
    : null,
```

### **4. Updated Chat View Page**

File: `lib/features/chat/presentation/pages/chat_view_page.dart`

#### **Key Changes**:

1. **Added scroll controller and state**:
```dart
final scrollController = useScrollController();
final showScrollButton = useState(false);
final previousMessageCount = useRef(0);
```

2. **Listen to scroll position**:
```dart
useEffect(() {
  void onScroll() {
    if (scrollController.hasClients) {
      final isAtBottom = scrollController.position.pixels >= 
          scrollController.position.maxScrollExtent - 100;
      showScrollButton.value = !isAtBottom;
    }
  }
  
  scrollController.addListener(onScroll);
  return () => scrollController.removeListener(onScroll);
}, [scrollController]);
```

3. **Scroll only on new message (if near bottom)**:
```dart
useEffect(() {
  messagesAsync.whenData((messages) {
    if (messages.length > previousMessageCount.value && scrollController.hasClients) {
      // Only scroll if we're already near the bottom
      final isNearBottom = scrollController.position.pixels >= 
          scrollController.position.maxScrollExtent - 200;
      
      if (isNearBottom) {
        WidgetsBinding.instance.addPostFrameCallback((_) {
          if (scrollController.hasClients) {
            scrollController.animateTo(
              scrollController.position.maxScrollExtent,
              duration: const Duration(milliseconds: 300),
              curve: Curves.easeOut,
            );
          }
        });
      }
    }
    previousMessageCount.value = messages.length;
  });
  return null;
}, [messagesAsync]);
```

4. **Floating scroll button**:
```dart
body: Stack(
  children: [
    Column(
      children: [
        Expanded(
          child: messagesAsync.when(
            data: (messages) {
              return ListView.builder(
                controller: scrollController,  // ‚Üê Added controller
                ...
              );
            },
            ...
          ),
        ),
        _InputBar(...),
      ],
    ),
    // Floating scroll to bottom button
    if (showScrollButton.value)
      Positioned(
        right: 16,
        bottom: 80,
        child: FloatingActionButton.small(
          onPressed: scrollToBottom,
          backgroundColor: colors.primary,
          foregroundColor: colors.onPrimary,
          child: const Icon(Icons.keyboard_arrow_down),
        ),
      ),
  ],
),
```

## üìä UI Examples

### **Conversation List**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Chats                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üü¢ [A] Phi Long                     ‚îÇ 5 ph√∫t tr∆∞·ªõc
‚îÇ     B·∫°n: üì∑ ·∫¢nh                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ    [G] Team Project                 ‚îÇ 2 gi·ªù tr∆∞·ªõc
‚îÇ     John: Let's meet tomorrow       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ    [H] Ho√†ng Th·∫£o                   ‚îÇ
‚îÇ     Ho·∫°t ƒë·ªông 3 ng√†y tr∆∞·ªõc          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Chat View with Scroll Button**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚Üê [A] Phi Long                      ‚îÇ
‚îÇ    ƒêang ho·∫°t ƒë·ªông                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ  Hello!                             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ                     How are you? ‚ñê  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  I'm good, thanks!                  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ                                  ‚¨á  ‚îÇ ‚Üê Scroll button
‚îÇ                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìé  [Type a message...]         ‚úà  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ Testing Checklist

### **Conversation List**:
- [ ] GROUP v·ªõi name hi·ªÉn th·ªã ƒë√∫ng name
- [ ] GROUP kh√¥ng c√≥ name hi·ªÉn th·ªã t√™n th√†nh vi√™n (max 3)
- [ ] DIRECT hi·ªÉn th·ªã nickname n·∫øu c√≥
- [ ] DIRECT fallback sang fullName n·∫øu kh√¥ng c√≥ nickname
- [ ] DIRECT fallback sang username n·∫øu kh√¥ng c√≥ fullName
- [ ] Last message t·ª´ user hi·ªÉn th·ªã "B·∫°n: ..."
- [ ] Last message l√† ·∫£nh hi·ªÉn th·ªã "üì∑ ·∫¢nh"
- [ ] Last message l√† file hi·ªÉn th·ªã "üìé T·ªáp"
- [ ] Online indicator hi·ªÉn th·ªã cho DIRECT conversations
- [ ] Last seen hi·ªÉn th·ªã ƒë√∫ng format
- [ ] Time ago hi·ªÉn th·ªã ƒë√∫ng

### **Chat View**:
- [ ] Kh√¥ng auto-scroll khi m·ªü chat
- [ ] Scroll xu·ªëng khi g·ª≠i tin nh·∫Øn
- [ ] Scroll xu·ªëng khi nh·∫≠n tin m·ªõi (n·∫øu ƒëang ·ªü cu·ªëi)
- [ ] Kh√¥ng scroll khi nh·∫≠n tin m·ªõi (n·∫øu ƒëang xem tin c≈©)
- [ ] Scroll button hi·ªÉn th·ªã khi scroll l√™n
- [ ] Scroll button ·∫©n khi ·ªü cu·ªëi
- [ ] Click scroll button scroll xu·ªëng m∆∞·ª£t

## üìù Files Modified

1. `lib/features/chat/domain/entities/conversation.dart` - Added lastMessage field
2. `lib/features/chat/domain/entities/participant.dart` - Added email, nickname, isOnline, lastSeen
3. `lib/features/chat/data/models/conversation_model.dart` - Added lastMessage parsing
4. `lib/features/chat/data/models/participant_model.dart` - Added new fields parsing
5. `lib/features/chat/presentation/utils/conversation_utils.dart` - **NEW** utility functions
6. `lib/features/chat/presentation/pages/chat_list_page.dart` - Updated UI with new display logic
7. `lib/features/chat/presentation/pages/chat_view_page.dart` - Added scroll improvements

## üìö Related Documentation

- `FLUTTER_REALTIME_UPDATES_IMPLEMENTATION.md` - WebSocket real-time updates
- `WEBSOCKET_AUTO_RECONNECT_FIX.md` - Auto-reconnect and heartbeat
- `REALTIME_UPDATES_DOCUMENTATION.md` - Backend WebSocket documentation

---

**Implemented by**: Augment Agent  
**Date**: 2025-10-20  
**Features**: Conversation display rules, last message formatting, user status, scroll improvements

