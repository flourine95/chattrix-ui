# Requirements Document - Fix Agora Join Channel Error (-17)

## Introduction

This document defines the requirements for fixing the Agora "errJoinChannelRejected" (error code -17) that occurs when attempting to join a channel. The token is successfully fetched from the backend, but the Agora SDK rejects the join request. This is typically caused by a mismatch between the channel profile used during token generation and the channel profile used when joining the channel.

## Glossary

- **Agora RTC Engine**: The Agora Real-Time Communication engine for audio/video calls
- **Channel Profile**: The communication mode (Communication vs Live Broadcasting)
- **Token**: Authentication token generated by backend for joining Agora channels
- **UID**: User ID in Agora channel (numeric)
- **errJoinChannelRejected**: Error code -17 indicating the join request was rejected
- **RtcTokenBuilder**: Backend service for generating Agora tokens
- **ChannelMediaOptions**: Configuration options when joining a channel
- **ClientRoleType**: User role in channel (Broadcaster vs Audience)

## Requirements

### Requirement 1

**User Story:** As a developer, I want to ensure the channel profile is consistent between token generation and channel join, so that users can successfully join calls.

#### Acceptance Criteria

1. WHEN generating a token THEN the system SHALL use ChannelProfileType.channelProfileCommunication
2. WHEN joining a channel THEN the system SHALL use the same ChannelProfileType.channelProfileCommunication
3. WHEN initializing the engine THEN the system SHALL set channelProfile to ChannelProfileType.channelProfileCommunication
4. WHEN setting ChannelMediaOptions THEN the system SHALL explicitly set channelProfile to match initialization
5. WHEN the profiles mismatch THEN the system SHALL log a warning before attempting to join

### Requirement 2

**User Story:** As a developer, I want to verify the Agora App ID and Certificate are correctly configured, so that token validation succeeds.

#### Acceptance Criteria

1. WHEN the app starts THEN the system SHALL validate AGORA_APP_ID is not empty
2. WHEN generating tokens THEN the backend SHALL use the correct AGORA_APP_CERTIFICATE
3. WHEN tokens are invalid THEN the system SHALL log the App ID being used (first 8 characters only)
4. WHEN the App ID mismatches THEN the system SHALL display a clear error message
5. WHEN debugging THEN the system SHALL provide a way to verify App ID matches between frontend and backend

### Requirement 3

**User Story:** As a developer, I want to simplify the Agora initialization and join flow, so that configuration errors are minimized.

#### Acceptance Criteria

1. WHEN initializing the engine THEN the system SHALL set all required parameters in one place
2. WHEN joining a channel THEN the system SHALL not override channel profile settings
3. WHEN ChannelMediaOptions are created THEN the system SHALL only set necessary options
4. WHEN the engine is already initialized THEN the system SHALL not reinitialize
5. WHEN joining fails THEN the system SHALL log all configuration parameters used

### Requirement 4

**User Story:** As a developer, I want detailed logging of the join channel process, so that I can diagnose issues quickly.

#### Acceptance Criteria

1. WHEN attempting to join THEN the system SHALL log the token (first 20 characters), channel ID, UID, and profile
2. WHEN join succeeds THEN the system SHALL log the success event with elapsed time
3. WHEN join fails THEN the system SHALL log the error code and message
4. WHEN Agora events occur THEN the system SHALL log all event details
5. WHEN debugging THEN the system SHALL log the full ChannelMediaOptions being used

### Requirement 5

**User Story:** As a developer, I want to verify the backend token generation uses the correct parameters, so that tokens are valid for the intended use case.

#### Acceptance Criteria

1. WHEN generating tokens THEN the backend SHALL use Role_Publisher for all users
2. WHEN generating tokens THEN the backend SHALL not specify a channel profile (defaults to Communication)
3. WHEN tokens expire THEN the system SHALL use the configured expiration time
4. WHEN the UID is generated THEN the system SHALL ensure it is a positive integer
5. WHEN token generation fails THEN the backend SHALL log the exact parameters used

### Requirement 6

**User Story:** As a user, I want clear error messages when join fails, so that I understand what went wrong.

#### Acceptance Criteria

1. WHEN error -17 occurs THEN the system SHALL display "Failed to join call. Please check your connection and try again."
2. WHEN the error is due to token THEN the system SHALL suggest "Token may be invalid. Please restart the app."
3. WHEN the error is due to network THEN the system SHALL suggest "Network error. Please check your internet connection."
4. WHEN the error persists THEN the system SHALL provide a way to report the issue with logs
5. WHEN debugging is enabled THEN the system SHALL show technical error details

### Requirement 7

**User Story:** As a developer, I want to test the Agora integration in isolation, so that I can verify the configuration is correct.

#### Acceptance Criteria

1. WHEN testing THEN the system SHALL provide a simple test method to join a test channel
2. WHEN the test succeeds THEN the system SHALL confirm Agora is configured correctly
3. WHEN the test fails THEN the system SHALL display the specific error and configuration used
4. WHEN testing THEN the system SHALL use the same code path as the real implementation
5. WHEN testing THEN the system SHALL clean up resources after the test

### Requirement 8

**User Story:** As a developer, I want to handle Agora SDK initialization errors gracefully, so that the app doesn't crash.

#### Acceptance Criteria

1. WHEN initialization fails THEN the system SHALL catch the exception and return a Failure
2. WHEN the App ID is invalid THEN the system SHALL display "Invalid Agora configuration. Please contact support."
3. WHEN the SDK is not available THEN the system SHALL display "Agora SDK not available. Please reinstall the app."
4. WHEN initialization succeeds THEN the system SHALL mark the engine as initialized
5. WHEN already initialized THEN the system SHALL skip reinitialization

### Requirement 9

**User Story:** As a developer, I want to ensure video/audio are enabled correctly before joining, so that media streams work properly.

#### Acceptance Criteria

1. WHEN joining a video call THEN the system SHALL enable video before joining
2. WHEN joining an audio call THEN the system SHALL disable video before joining
3. WHEN enabling video THEN the system SHALL start preview
4. WHEN enabling audio THEN the system SHALL enable the audio module
5. WHEN media setup fails THEN the system SHALL log the error and continue with join attempt

### Requirement 10

**User Story:** As a developer, I want to verify the ClientRoleType is set correctly, so that users can publish streams.

#### Acceptance Criteria

1. WHEN joining a channel THEN the system SHALL set clientRoleType to ClientRoleType.clientRoleBroadcaster
2. WHEN the role is Broadcaster THEN the system SHALL allow publishing audio/video
3. WHEN the role is Audience THEN the system SHALL only allow receiving streams
4. WHEN the role mismatches the token THEN the system SHALL log a warning
5. WHEN debugging THEN the system SHALL log the role being used
